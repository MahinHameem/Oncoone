{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment - OncoOne</title>
    <link rel="shortcut icon" href="{% static 'assets/images/logos.png' %}" type="image/png" />
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --light: #f7fafc;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 20px;
        }

        .payment-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .payment-header p {
            color: #718096;
            font-size: 14px;
        }

        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-top: 10px;
            font-weight: 600;
        }

        .payment-summary {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row label {
            color: #718096;
            font-weight: 500;
        }

        .summary-row .value {
            color: #2d3748;
            font-weight: 600;
        }

        .summary-row.total {
            padding: 12px 0;
            border-top: 2px solid var(--primary);
            margin-top: 8px;
            font-size: 16px;
        }

        .summary-row.total label {
            color: var(--primary);
            font-weight: 700;
        }

        .summary-row.total .value {
            color: var(--primary);
            font-weight: 700;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
            color: #2d3748;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row.expiry {
            grid-template-columns: 1fr 1fr 1fr;
        }

        #card-element {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            background: white;
        }

        #card-element.StripeElement--focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stripe-error {
            color: var(--danger);
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .stripe-error.show {
            display: block;
        }

        .terms-section {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .terms-checkbox input[type="checkbox"] {
            width: auto;
            margin-top: 3px;
        }

        .terms-checkbox label {
            margin: 0;
            font-size: 13px;
            color: #718096;
            font-weight: normal;
            cursor: pointer;
        }

        .terms-checkbox a {
            color: var(--primary);
            text-decoration: none;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        /* Policy modal */
        .policy-modal {
            position: fixed;
            inset: 0;
            background: rgba(26, 66, 114, 0.75);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .policy-modal.show {
            display: flex;
        }

        .policy-dialog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #1a202c;
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 20px;
            padding: 40px 36px;
            box-shadow: 0 25px 60px rgba(26, 66, 114, 0.3), 0 0 0 1px rgba(26, 66, 114, 0.1);
            position: relative;
            animation: slideUp 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .policy-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: linear-gradient(135deg, #1a4272 0%, #2a5a9a 100%);
            color: #ffffff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 66, 114, 0.2);
        }

        .policy-close:hover {
            background: linear-gradient(135deg, #2a5a9a 0%, #1a4272 100%);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 6px 18px rgba(26, 66, 114, 0.3);
        }

        .policy-title {
            margin-top: 0;
            margin-bottom: 8px;
            color: #1a4272;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #1a4272;
            padding-bottom: 12px;
        }

        .policy-meta {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 20px;
            font-style: italic;
        }

        .policy-dialog p {
            line-height: 1.7;
            color: #2d3748;
            margin-bottom: 14px;
        }

        .policy-section-title {
            margin: 24px 0 12px;
            font-weight: 700;
            font-size: 18px;
            color: #1a4272;
            padding-left: 12px;
            border-left: 4px solid #1a4272;
            background: rgba(26, 66, 114, 0.05);
            padding: 10px 12px;
            border-radius: 6px;
        }

        .policy-list {
            padding-left: 24px;
            margin: 12px 0;
        }

        .policy-list li {
            margin-bottom: 8px;
            color: #2d3748;
            line-height: 1.6;
        }

        .policy-list em {
            color: #667eea;
            font-weight: 600;
        }

        .policy-dialog::-webkit-scrollbar {
            width: 8px;
        }

        .policy-dialog::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .policy-dialog::-webkit-scrollbar-thumb {
            background: #1a4272;
            border-radius: 10px;
        }

        .policy-dialog::-webkit-scrollbar-thumb:hover {
            background: #2a5a9a;
        }

        .error-message {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--danger);
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-pay {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            grid-column: 1 / -1;
        }

        .btn-pay:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-pay:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-cancel {
            background: white;
            color: var(--primary);
            border: 2px solid var(--border);
        }

        .btn-cancel:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .card-brands {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 35px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 12px;
            color: #718096;
        }

        .card-brand:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .card-brand.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: #2d3748;
            margin-top: 20px;
            line-height: 1.5;
        }

        .info-box strong {
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .payment-container {
                padding: 25px;
            }

            .payment-header h1 {
                font-size: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-row.expiry {
                grid-template-columns: 1fr 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <!-- Header -->
        <div class="payment-header">
            <h1>üí≥ Secure Payment</h1>
            <p>Powered by Stripe</p>
            <div class="security-badge">
                üîí Secure & Encrypted
            </div>
        </div>

        <!-- Payment Summary -->
        <div class="payment-summary">
            <div class="summary-row">
                <label>Course</label>
                <span class="value">{{ course }}</span>
            </div>
            <div class="summary-row">
                <label>Amount</label>
                <span class="value">CAD ${{ payment_amount }}</span>
            </div>
            <div class="summary-row">
                <label>Tax (5% GST)</label>
                <span class="value">CAD ${{ tax_amount }}</span>
            </div>
            <div class="summary-row total">
                <label>Total Due</label>
                <span class="value">CAD ${{ total_amount }}</span>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Payment Form -->
        <form id="paymentForm" onsubmit="handlePayment(event)">
            <!-- Cardholder Name -->
            <div class="form-section">
                <label>Name on the Card</label>
                <div class="form-group">
                    <input type="text" id="cardholderName" placeholder="Card Name" required autocomplete="name">
                </div>
            </div>

            <!-- Stripe Card Element -->
            <div class="form-section">
                <label>Card Information <span style="color: #f56565;">*</span></label>
                <div class="security-note" style="font-size: 12px; color: #718096; margin-bottom: 8px;">
                    üîê Enter card number, expiry date, CVC, and postal code
                </div>
                <div id="card-element" style="padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: white;"></div>
                <div class="stripe-error" id="card-errors"></div>
                <div style="font-size: 11px; color: #a0aec0; margin-top: 6px;">
                    üí° Your CVC is the 3 or 4-digit security code on your card
                </div>
            </div>

            <!-- Email -->
            <div class="form-section">
                <label>Email Address</label>
                <div class="form-group">
                    <input type="email" id="email" value="{{ student_email }}" required readonly>
                </div>
            </div>

            <!-- Terms -->
            <div class="terms-section">
                <div class="terms-checkbox">
                    <input type="checkbox" id="termsCheck" required>
                    <label for="termsCheck">
                        I agree to the terms and conditions and authorize OncoOne to charge my card. I have reviewed the
                        <a href="#" onclick="openPolicyModal('privacyModal'); return false;">Privacy Policy</a>
                        and
                        <a href="#" onclick="openPolicyModal('conductModal'); return false;">Student Code of Conduct</a>.
                    </label>
                </div>
            </div>

            <!-- Buttons -->
            <button type="submit" class="btn btn-pay" id="payBtn">
                Pay CAD ${{ total_amount }}
            </button>
            <button type="button" class="btn btn-cancel" onclick="cancelPayment()">
                Cancel
            </button>
        </form>

        <!-- Security Info -->
        <div class="info-box">
            <strong>üîê Your Security & Privacy:</strong><br>
            ‚Ä¢ All card details including CVC are encrypted and processed securely by Stripe<br>
            ‚Ä¢ We never store your full card number or CVC<br>
            ‚Ä¢ Your payment is protected by industry-standard PCI DSS compliance<br>
            ‚Ä¢ After payment, you'll receive an OTP verification code and invoice via email
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="privacyTitle" onclick="if(event.target === this) closePolicyModal('privacyModal');">
        <div class="policy-dialog" onclick="event.stopPropagation();">
            <button class="policy-close" aria-label="Close" onclick="closePolicyModal('privacyModal')">√ó</button>
            <h3 id="privacyTitle" class="policy-title">Privacy Policy Notice</h3>
            <div class="policy-meta">OncoOne Aesthetic School &middot; Last Updated: 2026.01.10</div>
            <p>OncoOne Aesthetic School ("OncoOne", "we", "our", or "us") is a non-profit educational organization providing oncology-related aesthetic courses. We are committed to protecting your privacy and ensuring the security of your personal information. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website or register for our courses.</p>

            <div class="policy-section-title">1. Information We Collect</div>
            <p><strong>a. Personal Information</strong></p>
            <ul class="policy-list">
                <li>Full name</li>
                <li>Email address</li>
                <li>Phone number</li>
                <li>Professional or educational details (if provided during registration)</li>
            </ul>
            <p><strong>b. Payment Information</strong></p>
            <ul class="policy-list">
                <li>Payment amount</li>
                <li>Transaction reference number</li>
                <li>Payment status</li>
                <li><em>Note:</em> We do not store or process credit/debit card details directly. All payments are securely handled by third-party payment gateway providers.</li>
            </ul>
            <p><strong>c. Technical Information</strong></p>
            <ul class="policy-list">
                <li>IP address</li>
                <li>Browser type and device information</li>
                <li>Pages visited and interaction data (for analytics purposes)</li>
            </ul>

            <div class="policy-section-title">2. How We Use Your Information</div>
            <p>We use the collected information to:</p>
            <ul class="policy-list">
                <li>Process course registrations and payments</li>
                <li>Send confirmation and administrative emails</li>
                <li>Communicate course updates and important notices</li>
                <li>Maintain internal records for academic and compliance purposes</li>
                <li>Improve website functionality and user experience</li>
            </ul>
            <p>As a non-profit organization, we do not sell, rent, or trade your personal data.</p>

            <div class="policy-section-title">3. Payment Security</div>
            <p>All online payments are processed through secure, PCI-DSS-compliant payment gateways. OncoOne Aesthetic School does not have access to your full card details.</p>

            <div class="policy-section-title">4. Data Sharing and Disclosure</div>
            <p>We may share your information only with trusted service providers (e.g., payment gateways, email services) or legal/regulatory authorities when required by law. All third parties are obligated to keep your data confidential and secure.</p>

            <div class="policy-section-title">5. Data Retention</div>
            <p>We retain personal information only for as long as necessary to fulfill educational and administrative purposes or to comply with legal, accounting, or regulatory requirements.</p>

            <div class="policy-section-title">6. Your Rights</div>
            <p>You have the right to request access, correction, or deletion of your data, and to withdraw consent for communications at any time. Requests can be made using the contact details below.</p>

            <div class="policy-section-title">7. Cookies</div>
            <p>Our website may use cookies to enhance user experience and analyze website traffic. You may disable cookies through your browser settings if you prefer.</p>

            <div class="policy-section-title">8. Data Protection</div>
            <p>We implement appropriate technical and organizational security measures to protect your information against unauthorized access, alteration, disclosure, or destruction.</p>

            <div class="policy-section-title">9. Changes to This Policy</div>
            <p>We may update this Privacy Policy from time to time. Any changes will be posted on this page with an updated revision date.</p>

            <div class="policy-section-title">10. Contact Us</div>
            <div style="background: linear-gradient(135deg, #f0f4f8 0%, #e8f2ff 100%); border-radius: 12px; padding: 24px; margin-top: 16px; border: 2px solid #1a4272; box-shadow: 0 4px 12px rgba(26, 66, 114, 0.1);">
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="display: inline-block; background: linear-gradient(135deg, #1a4272 0%, #2a5a9a 100%); color: white; padding: 8px 20px; border-radius: 25px; font-weight: 700; font-size: 16px; box-shadow: 0 4px 8px rgba(26, 66, 114, 0.2);">
                        OncoOne Aesthetic School
                    </div>
                </div>
                <div style="display: grid; gap: 12px; margin-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: transform 0.2s ease;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #1a4272 0%, #2a5a9a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #718096; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Email</div>
                            <a href="mailto:info@oncoesthetics.ca" style="color: #1a4272; font-weight: 600; text-decoration: none; font-size: 15px;">info@oncoesthetics.ca</a>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: transform 0.2s ease;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #1a4272 0%, #2a5a9a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #718096; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Website</div>
                            <a href="https://www.oncoesthetics.ca" target="_blank" style="color: #1a4272; font-weight: 600; text-decoration: none; font-size: 15px;">www.oncoesthetics.ca</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Code of Conduct Modal -->
    <div id="conductModal" class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="conductTitle" onclick="if(event.target === this) closePolicyModal('conductModal');">
        <div class="policy-dialog" onclick="event.stopPropagation();">
            <button class="policy-close" aria-label="Close" onclick="closePolicyModal('conductModal')">√ó</button>
            <h3 id="conductTitle" class="policy-title">Student Code of Conduct</h3>
            <p>To maintain a safe, respectful, and professional learning environment, all students agree to the following:</p>

            <div class="policy-section-title">Professionalism</div>
            <ul class="policy-list">
                <li>Arrive prepared, punctual, and ready to learn.</li>
                <li>All materials used belong to OncoOne unless part of your kit; if property is damaged or misused, the student is responsible.</li>
                <li>Maintain professional behaviour and communication.</li>
                <li>Follow all safety and sanitation protocols.</li>
            </ul>

            <div class="policy-section-title">Respect & Trauma-Informed Behaviour</div>
            <ul class="policy-list">
                <li>Treat peers, instructors, and clients with empathy, dignity, and compassion.</li>
                <li>Honour the lived experiences of cancer patients and survivors.</li>
                <li>Maintain a calm, supportive presence.</li>
            </ul>

            <div class="policy-section-title">Privacy & Confidentiality</div>
            <ul class="policy-list">
                <li>Protect all personal information shared in class and do not share outside the OncoOne classroom.</li>
                <li>No recording or photography unless authorized.</li>
                <li>Patient confidentiality is enforced and should only be discussed within the program and in class.</li>
            </ul>

            <div class="policy-section-title">Hygiene & Safety</div>
            <ul class="policy-list">
                <li>Follow oncology-safe sanitation and disinfection protocols.</li>
                <li>Maintain a clean, professional appearance; hair tied back and closed shoes.</li>
                <li>Report safety concerns immediately.</li>
                <li>Wear perfume sparingly; cancer patients are sensitive to smells.</li>
            </ul>

            <div class="policy-section-title">Zero-Tolerance Policies</div>
            <ul class="policy-list">
                <li>Harassment, discrimination, unsafe practice, dishonesty, or breach of confidentiality may result in dismissal with no refund.</li>
            </ul>
        </div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        // Initialize Stripe with enhanced card element options
        const stripe = Stripe('{{ stripe_public_key }}');
        const elements = stripe.elements();
        
        // Create card element with CVC explicitly required and styled
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#2d3748',
                    fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
                    '::placeholder': {
                        color: '#a0aec0'
                    },
                    iconColor: '#667eea'
                },
                invalid: {
                    color: '#f56565',
                    iconColor: '#f56565'
                }
            },
            hidePostalCode: false,  // Collect postal code for additional verification
            iconStyle: 'solid'
        });
        
        cardElement.mount('#card-element');

        // Track card completion status
        let cardComplete = false;

        // Handle card element changes with enhanced validation
        cardElement.addEventListener('change', (event) => {
            const displayError = document.getElementById('card-errors');
            cardComplete = event.complete;
            
            if (event.error) {
                displayError.textContent = event.error.message;
                displayError.classList.add('show');
            } else if (!event.complete) {
                // Show helpful messages for incomplete fields
                const missingFields = [];
                if (!event.value.postalCode) missingFields.push('postal code');
                
                if (missingFields.length > 0 && event.value.number) {
                    displayError.textContent = `Please complete all card fields including CVC and ${missingFields.join(', ')}`;
                    displayError.classList.add('show');
                } else {
                    displayError.textContent = '';
                    displayError.classList.remove('show');
                }
            } else {
                displayError.textContent = '';
                displayError.classList.remove('show');
            }
        });

        // Form data
        const studentId = {{ student_id }};
        const enrollmentId = {{ enrollment_id }};
        const paymentAmount = parseFloat('{{ payment_amount }}');
        const taxAmount = parseFloat('{{ tax_amount }}');
        const totalAmount = parseFloat('{{ total_amount }}');
        const stripePublicKey = '{{ stripe_public_key }}';

        // Handle payment submission with CVC validation
        async function handlePayment(event) {
            event.preventDefault();

            const cardholderName = document.getElementById('cardholderName').value.trim();
            const email = document.getElementById('email').value.trim();
            const termsCheck = document.getElementById('termsCheck').checked;
            const payBtn = document.getElementById('payBtn');
            const errorDiv = document.getElementById('errorMessage');

            // Enhanced validation
            if (!cardholderName || cardholderName.length < 3) {
                showError('Please enter a valid cardholder name (minimum 3 characters)');
                return;
            }

            // Validate cardholder name format (letters, spaces, hyphens, apostrophes)
            const namePattern = /^[a-zA-Z\s\-']+$/;
            if (!namePattern.test(cardholderName)) {
                showError('Cardholder name should contain only letters, spaces, hyphens, and apostrophes');
                return;
            }

            if (!email || !email.includes('@')) {
                showError('Please enter a valid email address');
                return;
            }

            if (!termsCheck) {
                showError('You must agree to the terms and conditions to proceed');
                return;
            }

            // Verify card element is complete (includes CVC validation)
            if (!cardComplete) {
                showError('Please complete all card details including card number, expiry date, CVC, and postal code');
                cardElement.focus();
                return;
            }

            if (!stripePublicKey || stripePublicKey.includes('YOUR')) {
                showError('‚ö†Ô∏è Payment system not configured. Please contact support.');
                return;
            }

            // Disable button and show loading state
            payBtn.disabled = true;
            payBtn.innerHTML = '<span class="loading-spinner"></span>üîí Processing Secure Payment...';
            errorDiv.classList.remove('show');

            try {
                // Create payment method from card (Stripe validates CVC automatically)
                const { paymentMethod, error: pmError } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: cardholderName,
                        email: email
                    }
                });

                if (pmError) {
                    // Handle specific CVC errors
                    let errorMessage = pmError.message;
                    if (pmError.code === 'incomplete_cvc' || pmError.message.toLowerCase().includes('cvc')) {
                        errorMessage = 'üîê Please enter a valid CVC/CVV code (3 or 4 digits on the back of your card)';
                    } else if (pmError.code === 'incomplete_number') {
                        errorMessage = 'üí≥ Please enter a complete and valid card number';
                    } else if (pmError.code === 'incomplete_expiry') {
                        errorMessage = 'üìÖ Please enter a valid expiry date';
                    } else if (pmError.code === 'incomplete_zip') {
                        errorMessage = 'üìç Please enter a valid postal/ZIP code';
                    }
                    
                    showError(errorMessage);
                    payBtn.disabled = false;
                    payBtn.innerHTML = `Pay CAD $${totalAmount.toFixed(2)}`;
                    cardElement.focus();
                    return;
                }

                // Verify payment method was created successfully
                if (!paymentMethod || !paymentMethod.id) {
                    showError('Failed to process card information. Please try again.');
                    payBtn.disabled = false;
                    payBtn.innerHTML = `Pay CAD $${totalAmount.toFixed(2)}`;
                    return;
                }

                // Send to backend to create payment and OTP
                const response = await fetch('/api/payment/create-and-send-otp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        enrollment_id: enrollmentId,
                        payment_method_id: paymentMethod.id,
                        card_holder: cardholderName,
                        card_type: paymentMethod.card.brand,
                        card_last_four: paymentMethod.card.last4,
                        payment_amount: paymentAmount,
                        tax_amount: taxAmount,
                        total_amount: totalAmount,
                        email: email
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    showError(data.error || 'Payment processing failed');
                    payBtn.disabled = false;
                    payBtn.innerHTML = `Pay CAD $${totalAmount}`;
                    return;
                }

                // Redirect to OTP verification
                window.location.href = `/api/payment/otp-verification/${data.payment_id}/`;

            } catch (error) {
                showError('An error occurred: ' + error.message);
                payBtn.disabled = false;
                payBtn.innerHTML = `Pay CAD $${totalAmount}`;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelPayment() {
            if (confirm('Are you sure you want to cancel this payment?')) {
                window.location.href = `/api/payment/cancelled/${studentId}/`;
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function openPolicyModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closePolicyModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Focus on card element when page loads
        window.addEventListener('load', () => {
            cardElement.focus();
        });
    </script>
</body>
</html>
