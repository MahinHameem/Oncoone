{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Payments</title>
  <link rel="stylesheet" href="{% static 'assets/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="shortcut icon" href="{% static 'assets/images/logos.png' %}" type="image/png">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f8fb; }
    .navbar { background-color: #1a4272; }
    .navbar a.nav-link { color: white; font-weight: 500; }
    .navbar a.nav-link:hover { color: #cce0ff; }
    .container-admin { padding: 40px 20px; }
    table { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    table thead th { background-color: #1a4272 !important; color: #fff !important; text-align: center; padding: 12px; font-weight: 600; }
    table td { text-align: center; vertical-align: middle; padding: 10px; }
    .brand-logo { height: 36px; margin-right: 10px; }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-completed { background-color: #d4edda; color: #155724; }
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-failed { background-color: #f8d7da; color: #721c24; }
    .status-cancelled { background-color: #e2e3e5; color: #383d41; }
    .btn-download {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-download:hover {
      background-color: #218838;
    }
    .search-box {
      margin-bottom: 20px;
      max-width: 400px;
    }
    .summary-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .summary-card {
      flex: 1;
      min-width: 200px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    .summary-card h3 {
      color: #1a4272;
      font-size: 28px;
      margin: 0;
    }
    .summary-card p {
      color: #666;
      margin: 5px 0 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top py-3">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img class="brand-logo" src="{% static 'assets/images/logos.png' %}" alt="Logo">
      <span>OncoOne Admin</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="{% url 'admin-students-page' %}">Students Details</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'admin-courses-page' %}">Edit Courses</a></li>
        <li class="nav-item"><a class="nav-link active" href="{% url 'admin-payments-page' %}">Payments</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'staff-logout' %}">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container container-admin">
  <h2 class="mb-4" style="color:#1a4272">Payment History</h2>
  
  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card">
      <h3 id="totalPayments">0</h3>
      <p>Total Payments</p>
    </div>
    <div class="summary-card">
      <h3 id="totalRevenue">$0.00</h3>
      <p>Total Revenue</p>
    </div>
    <div class="summary-card">
      <h3 id="completedPayments">0</h3>
      <p>Completed</p>
    </div>
    <div class="summary-card">
      <h3 id="pendingPayments">0</h3>
      <p>Pending</p>
    </div>
  </div>

  <!-- Search Box -->
  <div class="search-box">
    <input 
      type="text" 
      id="searchInput" 
      class="form-control" 
      placeholder="Search by student name, email, invoice number..."
    >
  </div>

  <div id="fetchError" class="alert alert-danger d-none" role="alert"></div>
  
  <!-- Payments Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="paymentsTable">
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Student Name</th>
          <th>Email</th>
          <th>Course</th>
          <th>Amount Paid</th>
          <th>Total Price</th>
          <th>Balance</th>
          <th>Status</th>
          <th>Payment Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="payments-tbody">
        <tr>
          <td colspan="10" class="text-center">Loading payments...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let allPayments = [];

    // Fetch all payments
    function loadPayments() {
      fetch('/api/admin/payments/')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            allPayments = data.payments;
            renderPayments(allPayments);
            updateSummary(allPayments);
          } else {
            showError('Failed to load payments');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showError('Error loading payments');
        });
    }

    // Render payments table
    function renderPayments(payments) {
      const tbody = document.getElementById('payments-tbody');
      
      if (payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">No payments found</td></tr>';
        return;
      }

      tbody.innerHTML = payments.map(payment => {
        const balanceValue = payment.remaining_cad !== undefined
          ? parseFloat(payment.remaining_cad)
          : (parseFloat(payment.total_price_cad) - parseFloat(payment.payment_amount_cad));
        const balance = balanceValue.toFixed(2);
        const statusClass = `status-${payment.status}`;
        
        return `
          <tr>
            <td><strong>${payment.invoice_number || 'N/A'}</strong></td>
            <td>${payment.student_name}</td>
            <td>${payment.student_email}</td>
            <td>${payment.course_name}</td>
            <td>$${parseFloat(payment.payment_amount_cad).toFixed(2)}</td>
            <td>$${parseFloat(payment.total_price_cad).toFixed(2)}</td>
            <td>$${balance}</td>
            <td><span class="status-badge ${statusClass}">${payment.status}</span></td>
            <td>${formatDate(payment.created_at)}</td>
            <td>
              ${payment.status === 'completed' && payment.invoice_number ? 
                `<button class="btn-download" onclick="downloadInvoice(${payment.id})">
                  <i class="fas fa-download"></i> Invoice
                </button>` : 
                '<span class="text-muted">N/A</span>'
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update summary cards
    function updateSummary(payments) {
      const total = payments.length;
      const completed = payments.filter(p => p.status === 'completed').length;
      const pending = payments.filter(p => p.status === 'pending').length;
      const revenue = payments
        .filter(p => p.status === 'completed')
        .reduce((sum, p) => sum + parseFloat(p.payment_amount_cad), 0);

      document.getElementById('totalPayments').textContent = total;
      document.getElementById('totalRevenue').textContent = `$${revenue.toFixed(2)}`;
      document.getElementById('completedPayments').textContent = completed;
      document.getElementById('pendingPayments').textContent = pending;
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allPayments.filter(payment => {
        return (
          payment.student_name.toLowerCase().includes(searchTerm) ||
          payment.student_email.toLowerCase().includes(searchTerm) ||
          (payment.invoice_number && payment.invoice_number.toLowerCase().includes(searchTerm)) ||
          payment.course_name.toLowerCase().includes(searchTerm)
        );
      });
      renderPayments(filtered);
    });

    // Download invoice function
    window.downloadInvoice = function(paymentId) {
      window.location.href = `/api/admin/download-invoice/${paymentId}/`;
    };

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Show error
    function showError(message) {
      const errorDiv = document.getElementById('fetchError');
      errorDiv.textContent = message;
      errorDiv.classList.remove('d-none');
      document.getElementById('payments-tbody').innerHTML = 
        '<tr><td colspan="10" class="text-center text-danger">Error loading payments</td></tr>';
    }

    // Initial load
    loadPayments();
  });
</script>
</body>
</html>
